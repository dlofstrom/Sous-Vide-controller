//---------------------------------------------------------
//  Sous vide cooker
//  author: dlofstrom
//  date: 2016-11-06
//  
//  TODOS:
//  - Create user flow
//  - PID temperature regulator
//  - User serial as debug port
//      data on/off
//  - Store settings in EEPROM
//      Pump speed
//      PID coefficients
//      Temperature calibration
//      Temperature range
//  
//---------------------------------------------------------
#include <LiquidCrystal.h>
#include <avr/pgmspace.h>

#define THERMISTOR_PIN 0
#define POT_PIN 3
#define BUTTON_PIN 8

#define PUMP_PIN 6
#define HEATER_PIN 7
#define LED_PIN 13

const int16_t thermistor_lookup[1024] PROGMEM = {32767, 32767, 32767, 31681, 29656, 28168, 27001, 26047, 25244, 24552, 23947, 23409, 22927, 22490, 22090, 21724, 21385, 21070, 20776, 20500, 20241, 19997, 19766, 19547, 19339, 19140, 18951, 18770, 18596, 18430, 18270, 
18116, 17968, 17825, 17687, 17553, 17424, 17299, 17177, 17059, 16945, 16834, 16726, 16621, 16518, 16418, 16321, 16226, 16133, 16043, 15954, 15868, 15783, 15700, 15619, 15540, 15462, 15386, 15311, 15238, 15166, 15096, 15026, 14958, 14891, 14826, 14761, 14697, 14635, 
14573, 14513, 14453, 14395, 14337, 14280, 14224, 14169, 14115, 14061, 14008, 13956, 13904, 13854, 13804, 13754, 13705, 13657, 13610, 13563, 13516, 13470, 13425, 13380, 13336, 13292, 13249, 13207, 13164, 13123, 13081, 13040, 13000, 12960, 12920, 12881, 12842, 12804, 
12766, 12728, 12691, 12654, 12618, 12581, 12546, 12510, 12475, 12440, 12405, 12371, 12337, 12304, 12270, 12237, 12204, 12172, 12140, 12108, 12076, 12045, 12013, 11982, 11952, 11921, 11891, 11861, 11831, 11802, 11773, 11744, 11715, 11686, 11658, 11629, 11601, 11574, 
11546, 11519, 11491, 11464, 11437, 11411, 11384, 11358, 11332, 11306, 11280, 11254, 11229, 11203, 11178, 11153, 11128, 11104, 11079, 11055, 11031, 11007, 10983, 10959, 10935, 10912, 10888, 10865, 10842, 10819, 10796, 10773, 10751, 10728, 10706, 10684, 10662, 10640, 
10618, 10596, 10574, 10553, 10531, 10510, 10489, 10468, 10447, 10426, 10405, 10384, 10364, 10343, 10323, 10303, 10283, 10262, 10242, 10223, 10203, 10183, 10163, 10144, 10125, 10105, 10086, 10067, 10048, 10029, 10010, 9991, 9973, 9954, 9936, 9917, 9899, 9881, 9863, 
9845, 9827, 9809, 9792, 9774, 9756, 9739, 9721, 9704, 9687, 9669, 9652, 9635, 9618, 9601, 9584, 9567, 9550, 9534, 9517, 9500, 9484, 9467, 9451, 9434, 9418, 9402, 9386, 9370, 9353, 9337, 9321, 9305, 9290, 9274, 9258, 9242, 9227, 9211, 9196, 9180, 9165, 9149, 9134, 
9119, 9103, 9088, 9073, 9058, 9043, 9028, 9013, 8998, 8983, 8968, 8954, 8939, 8924, 8910, 8895, 8880, 8866, 8851, 8837, 8823, 8808, 8794, 8780, 8765, 8751, 8737, 8723, 8709, 8695, 8681, 8667, 8653, 8639, 8625, 8612, 8598, 8584, 8570, 8557, 8543, 8530, 8516, 8502, 
8489, 8476, 8462, 8449, 8435, 8422, 8409, 8396, 8382, 8369, 8356, 8343, 8330, 8317, 8304, 8291, 8278, 8265, 8252, 8239, 8226, 8213, 8201, 8188, 8175, 8162, 8150, 8137, 8124, 8112, 8099, 8087, 8074, 8062, 8049, 8037, 8024, 8012, 8000, 7987, 7975, 7963, 7951, 7938, 
7926, 7914, 7902, 7890, 7877, 7865, 7853, 7841, 7829, 7817, 7805, 7793, 7781, 7769, 7758, 7746, 7734, 7722, 7710, 7698, 7687, 7675, 7663, 7652, 7640, 7628, 7617, 7605, 7593, 7582, 7570, 7559, 7547, 7536, 7524, 7513, 7501, 7490, 7478, 7467, 7456, 7444, 7433, 7422, 
7410, 7399, 7388, 7377, 7365, 7354, 7343, 7332, 7321, 7309, 7298, 7287, 7276, 7265, 7254, 7243, 7232, 7221, 7210, 7199, 7188, 7177, 7166, 7155, 7144, 7133, 7122, 7111, 7100, 7090, 7079, 7068, 7057, 7046, 7035, 7025, 7014, 7003, 6992, 6982, 6971, 6960, 6950, 6939, 
6928, 6918, 6907, 6896, 6886, 6875, 6865, 6854, 6843, 6833, 6822, 6812, 6801, 6791, 6780, 6770, 6759, 6749, 6738, 6728, 6717, 6707, 6697, 6686, 6676, 6665, 6655, 6645, 6634, 6624, 6613, 6603, 6593, 6582, 6572, 6562, 6552, 6541, 6531, 6521, 6511, 6500, 6490, 6480, 
6470, 6459, 6449, 6439, 6429, 6419, 6408, 6398, 6388, 6378, 6368, 6358, 6347, 6337, 6327, 6317, 6307, 6297, 6287, 6277, 6267, 6256, 6246, 6236, 6226, 6216, 6206, 6196, 6186, 6176, 6166, 6156, 6146, 6136, 6126, 6116, 6106, 6096, 6086, 6076, 6066, 6056, 6046, 6036, 
6026, 6016, 6006, 5996, 5986, 5976, 5966, 5956, 5947, 5937, 5927, 5917, 5907, 5897, 5887, 5877, 5867, 5857, 5847, 5838, 5828, 5818, 5808, 5798, 5788, 5778, 5768, 5758, 5749, 5739, 5729, 5719, 5709, 5699, 5689, 5680, 5670, 5660, 5650, 5640, 5630, 5620, 5611, 5601, 
5591, 5581, 5571, 5561, 5551, 5542, 5532, 5522, 5512, 5502, 5492, 5483, 5473, 5463, 5453, 5443, 5433, 5423, 5414, 5404, 5394, 5384, 5374, 5364, 5354, 5345, 5335, 5325, 5315, 5305, 5295, 5285, 5276, 5266, 5256, 5246, 5236, 5226, 5216, 5207, 5197, 5187, 5177, 5167, 
5157, 5147, 5137, 5127, 5118, 5108, 5098, 5088, 5078, 5068, 5058, 5048, 5038, 5028, 5018, 5008, 4998, 4989, 4979, 4969, 4959, 4949, 4939, 4929, 4919, 4909, 4899, 4889, 4879, 4869, 4859, 4849, 4839, 4829, 4819, 4809, 4799, 4789, 4779, 4769, 4759, 4749, 4739, 4729, 
4719, 4709, 4699, 4689, 4679, 4669, 4659, 4648, 4638, 4628, 4618, 4608, 4598, 4588, 4577, 4567, 4557, 4547, 4537, 4527, 4516, 4506, 4496, 4486, 4475, 4465, 4455, 4445, 4434, 4424, 4414, 4403, 4393, 4383, 4372, 4362, 4352, 4341, 4331, 4320, 4310, 4300, 4289, 4279, 
4268, 4258, 4247, 4237, 4226, 4216, 4205, 4195, 4184, 4174, 4163, 4152, 4142, 4131, 4120, 4110, 4099, 4088, 4078, 4067, 4056, 4046, 4035, 4024, 4013, 4003, 3992, 3981, 3970, 3959, 3948, 3937, 3926, 3916, 3905, 3894, 3883, 3872, 3861, 3850, 3839, 3828, 3816, 3805, 
3794, 3783, 3772, 3761, 3750, 3738, 3727, 3716, 3705, 3693, 3682, 3671, 3659, 3648, 3637, 3625, 3614, 3602, 3591, 3579, 3568, 3556, 3545, 3533, 3521, 3510, 3498, 3486, 3475, 3463, 3451, 3439, 3428, 3416, 3404, 3392, 3380, 3368, 3356, 3344, 3332, 3320, 3308, 3296, 
3284, 3272, 3260, 3247, 3235, 3223, 3210, 3198, 3186, 3173, 3161, 3148, 3136, 3123, 3111, 3098, 3086, 3073, 3060, 3047, 3035, 3022, 3009, 2996, 2983, 2970, 2957, 2944, 2931, 2918, 2905, 2892, 2879, 2865, 2852, 2839, 2825, 2812, 2798, 2785, 2771, 2758, 2744, 2730, 
2717, 2703, 2689, 2675, 2661, 2647, 2633, 2619, 2605, 2591, 2577, 2562, 2548, 2534, 2519, 2505, 2490, 2476, 2461, 2446, 2432, 2417, 2402, 2387, 2372, 2357, 2342, 2327, 2311, 2296, 2281, 2265, 2250, 2234, 2218, 2203, 2187, 2171, 2155, 2139, 2123, 2107, 2090, 2074, 
2058, 2041, 2025, 2008, 1991, 1975, 1958, 1941, 1924, 1906, 1889, 1872, 1854, 1837, 1819, 1801, 1784, 1766, 1748, 1729, 1711, 1693, 1674, 1656, 1637, 1618, 1599, 1580, 1561, 1542, 1522, 1503, 1483, 1463, 1443, 1423, 1403, 1383, 1362, 1341, 1320, 1300, 1278, 1257, 
1236, 1214, 1192, 1170, 1148, 1126, 1103, 1081, 1058, 1035, 1011, 988, 964, 940, 916, 892, 867, 842, 817, 792, 766, 740, 714, 688, 661, 634, 607, 579, 552, 523, 495, 466, 437, 407, 377, 347, 317, 285, 254, 222, 190, 157, 124, 90, 55, 21, -15, -51, -87, -124, -162, 
-200, -239, -279, -320, -361, -403, -446, -490, -535, -581, -628, -676, -725, -776, -827, -880, -935, -991, -1049, -1108, -1170, -1233, -1298, -1366, -1437, -1510, -1586, -1665, -1748, -1835, -1926, -2022, -2123, -2231, -2346, -2468, -2601, -2744, -2901, -3074, 
-3268, -3488, -3744, -4052, -4438, -4964, -5818};

//LCD Pins
LiquidCrystal lcd(12, 11, 5, 4, 3, 2);

uint8_t system_mode = 0;
int pot_value = 0;
int16_t temperature_setpoint = 0;
int16_t analog_value = 0;
int16_t temperature_value = 0;
int16_t temperature_measured = 0;
uint8_t heater_state = 0;
const float iir_divisor = 0.1f;
uint8_t button_val = LOW;
uint8_t button_old = LOW;

void print_lcd() {
  if (system_mode == 0) {
    lcd.setCursor(0, 0);
    lcd.print("Set temperature ");

    //Clear bottom screen
    lcd.setCursor(0, 1);
    lcd.print("                ");
    lcd.setCursor(0, 1);
    lcd.print(pot_value);
    lcd.setCursor(8,1);
    lcd.print(temperature_setpoint);
  } else {
    lcd.setCursor(0, 0);
    lcd.print("Cooking         ");
    lcd.setCursor(0, 1);
    lcd.print("                ");
    lcd.setCursor(0, 1);
    lcd.print(temperature_setpoint);
    lcd.setCursor(8,1);
    lcd.print(temperature_value);    
  }
}

unsigned long tic;
unsigned long toc;
void setup() {
  //16x2 Display
  lcd.begin(16, 2);

  //Logging
  Serial.begin(9600);
  
  //Outputs
  pinMode(PUMP_PIN, OUTPUT);
  digitalWrite(PUMP_PIN, HIGH);
  pinMode(HEATER_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);

  //Initial message
  lcd.print("Sous vide cooker");
  delay(5000);

  tic = millis();
  toc = millis();
}


void loop() {
  toc = millis();

  if (system_mode == 0) {
    //Choose temperature mode
    //Shut down everything
    digitalWrite(HEATER_PIN, LOW);
    //analogWrite(PUMP_PIN, 0);
    digitalWrite(PUMP_PIN, HIGH);

    //Read potentiometer and choose temperature setpoint
    pot_value = analogRead(POT_PIN);
    temperature_setpoint = map(pot_value, 0, 1023, 2500, 8500);
  } else {
    //Cooking mode
    //Pump at full speed
    //analogWrite(PUMP_PIN, 255);
    digitalWrite(PUMP_PIN, LOW);
    
    //Read temperature and control heater
    analog_value = analogRead(THERMISTOR_PIN);
    temperature_value = pgm_read_word(&thermistor_lookup[analog_value]);
    //IIR filter for more stable temperature
    temperature_measured = (int16_t)(iir_divisor*(float)temperature_value + (1.0 - iir_divisor)*(float)temperature_measured);
    
    //Regulate every 5 seconds
    if (toc - tic >= 5000) {
      if (temperature_value < temperature_setpoint) {
        digitalWrite(HEATER_PIN, HIGH);
      } else {
        digitalWrite(HEATER_PIN, LOW);
      }
      tic = toc;
    }
  }

  //Read button and toggle state
  //TODO: Do proper debounce and edge detection
  button_val = digitalRead(BUTTON_PIN);
  if (button_old == LOW && button_val == HIGH) {
    system_mode ^= 0x01;
  }
  button_old = button_val;

  //Print to LCD
  print_lcd();

  //Logging print
  Serial.print(millis());
  Serial.print(";");
  Serial.print(temperature_setpoint);
  Serial.print(";");
  Serial.print(analog_value);
  Serial.print(";");
  Serial.print(temperature_value);
  Serial.print(";");
  Serial.println(heater_state);
  
  
  //Speed not important for now
  delay(500);
}
